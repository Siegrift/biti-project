\chapter{Cross site scripting}

\label{chapter:xss} % chapter id (used by ref command)

Cross site scripting (abbr. XSS) is one of the most prevalent security vulnerabilities and the most
common one when talking about web applications. When we take into the account only the last year
(year 2020), XSS has been ranked on 7th place in the OWASP top 10 vulnerabilities ranking.
\cite{owasp_top_ten_vulns}. When, we look at the bounty programs only, and the money rewarded for
each security vulnerability, we can see that XSS is the winner. Total bounty just for XSS was more
than $4,2$ million USD \cite{top_ten_rewarded_vulns}.

Citing very well written introduction from \cite{xss_owasp_intro}.

\begin{quotation}
  XSS attacks are a type of injection, in which malicious scripts are injected into otherwise benign
  and trusted websites. XSS attacks occur when an attacker uses a web application to send malicious
  code, generally in the form of a browser side script (for example encoded in URL), to a different
  end user. Flaws that allow these attacks to succeed are quite widespread and occur anywhere a web
  application uses input from a user within the output it generates without validating or encoding
  it \cite{xss_owasp_intro}.

  An attacker can use XSS to send a malicious script to an unsuspecting user. The end user’s browser
  has no way to know that the script should not be trusted, and will execute the script. Because it
  thinks the script came from a trusted source, the malicious script can access any cookies, session
  tokens, or other sensitive information retained by the browser and used with that site. These
  scripts can even rewrite the content of the HTML page \cite{xss_owasp_intro}.

  \emph{(Be sure to read the cited article for more information and links \cite{xss_owasp_intro}.
    The above paragraphs were also largely copied from that very well written article.)}
\end{quotation}

\section{Types of XSS}
\label{chapter:xss:types}

There are many types of XSS, although there is no single finite list of XSS types to rule them all
\cite{lotr_fellowship}. Most experts distinguish at least between non-persistent \emph{(reflected)}
and persistent \emph{(stored)}. There is also a third category \emph{DOM based XSS} which will be
explained in more depth as this is the threat model under which Trusted Types operate.

\begin{itemize}
  \item  Stored - The injected script is permanently saved in server database. The client
        \emph{(user's browser)} will then ask the server for the requested page and the response
        from the server will contain the malicious script.
  \item  Reflected - Typically delivered via email or a neutral web site. occur when a malicious
        script is reflected off of a web application to the victim’s browser \cite{reflected_xss}.
  \item  DOM based - The vulnerability appears in the DOM - by executing some malicious code. In
        reflective and stored Cross-site scripting attacks you can see the vulnerability payload in
        the response page but in DOM based cross-site scripting, the HTML source code and response
        of the attack will be exactly the same. You can only observe the change at runtime.
\end{itemize}

\section{Modern classification of XSS}

The classification in the \emph{\hyperref[chapter:xss:types]{Section 1.1 - Types of XSS}} was
created many years back and a lot has since changed. The web got more secure and modern frameworks
try to enforce best security practices for developers using them. However, web has since evolved
rapidly \emph{and still evolves} while still mostly preserving the backward compatibility with
original JS spec - meaning you could still browse the web page created ~20 years ago with subtle
differences \emph{(Compare that with running Android app created for version 4.1 Jelly Bean created
  in mid 2012 on Android 11 released 2020 - good luck with that)}.

The previous classification is not ideal, because the categories overlap. Citing from
\cite{xss_owasp_types}:
\begin{quotation}
  You can have both Stored and Reflected DOM Based XSS. You can also have Stored and Reflected
  Non-DOM Based XSS too, but that’s confusing, so to help clarify things, starting about mid 2012,
  the research community proposed and started using two new terms to help organize the types of XSS
  that can occur:
\end{quotation}

Instead what they propose is just two categories (again, fully citing \cite{xss_owasp_types}):

\begin{itemize}
  \item  Server XSS - Server XSS occurs when untrusted user supplied data is included in an HTTP
        response generated by the server. The source of this data could be from the request, or from
        a stored location. As such, you can have both Reflected Server XSS and Stored Server XSS. In
        this case, the entire vulnerability is in server-side code, and the browser is simply
        rendering the response and executing any valid script embedded in it.
  \item  Client XSS - Client XSS occurs when untrusted user supplied data is used to update the DOM
        with an unsafe JavaScript call. A JavaScript call is considered unsafe if it can be used to
        introduce valid JavaScript into the DOM. This source of this data could be from the DOM, or
        it could have been sent by the server (via an AJAX call, or a page load). The ultimate
        source of the data could have been from a request, or from a stored location on the client
        or the server. As such, you can have both Reflected Client XSS and Stored Client XSS.
\end{itemize}

Just for completeness, DOM based XSS is a subset of client XSS. The source of the data is client
side only. And again, study the full article \emph{(together with further references)} for more
information \cite{xss_owasp_types}.

\section{Common examples of XSS}

The basic example of XSS \emph{and probably the easiest to understand} is to take a page which
interpolates data from an URL. This is a common practice - you browse a site, find something of
value and you want to share it with your friend. Nothing easier, you just copy the URL and they see
the same content \emph{or at least similar} to you. This basic example is common for nearly all
shopping sites, tourism agencies, accommodation services etc...

This type of attack can be easily demonstrated with the following example page:
\bigskip

\begin{lstlisting}[language=HTML]
  <!DOCTYPE html>
  <html lang="en">
    <head>
      <meta charset="UTF-8">
      <title>URL XSS</title>
    </head>
    <body>
      <p>Try searching something:
        <i> (for example "<img src=x onerror=alert(1) />")</i>
      </p>
      <input id="query" type="text" />
      <button id="submit">Search</button>

      <p>You have searched for</p>
      <p id="attack-target"></p>
    </body>
    <script>
      window.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(location.search)
        document.getElementById('attack-target').innerHTML = urlParams.get('query')
      });

      document
        .getElementById('submit')
        .addEventListener('click', () => {
          const query = document.getElementById('query').value
          location.replace(
            `${location.pathname}?query=${encodeURIComponent(query)}`
          );
        })
    </script>
  </html>
\end{lstlisting}

This is very small example and XSS is apparent, but once the project is composed of tens of
thousands lines and many dependencies, such mistake can easily sneak through. In this case, if you
execute this HTML code in the browser and you try searching for something, the result will be
interpolated in the page. This allows the attacker to \emph{prepare an evil URL} which they can then
send to benign users to exploit.

\section{Consequences of XSS}

So far, we have talked about many types of XSS, saw a basic example and are aware that there are
many more. What we haven't covered are the consequences, which can be caused by these attacks.

TODO: write me

\section{Protection}

TODO: write me
